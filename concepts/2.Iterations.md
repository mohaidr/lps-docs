# Understanding Iterations

An **Iteration** defines the individual scenario performed during a round. The iteration mode controls how the iteration operates.

## Key Attributes of an Iteration
- **Name**: Identifier for the iteration.
- **HTTP Request**: Configuration for the request, including the method, URL, headers, and payload.
- **Mode**: Defines how the iteration operates (see **[Iteration Modes](https://github.com/mohaidr/lps-docs/blob/main/concepts/3.Iteration_Modes.md)**).
- **Startup Delay**: Optional delay before starting the iteration.
- **MaximizeThroughput (iteration)**  `maximizeThroughput: true` to push send-rate as fast as other constraints allow. <mark>Maximizing the throughput will result in higher CPU and Memory usage</mark>

**Structure**  
- The plan is at the **document root** (no `plan:` key).
- **Rounds** are required; each round contains one or more **iterations**.
- Each iteration typically contains an **httpRequest**.

## Iteration Features

### Itration Modes

- Iteration Modes control the pattern and timing of HTTP requests, offering flexibility to simulate various user behaviors and system loads. (see **[Iteration Modes](https://github.com/mohaidr/lps-docs/blob/main/concepts/3.Iteration_Modes.md)**).

### SkipIf
The `skipIf` property allows conditional execution of an iteration. If the condition evaluates to **true**, the iteration will be skipped.  
Conditions can use [Flee expressions](https://github.com/mparlak/Flee) and may reference session/global variables, placeholders, and metrics.

Example use cases:
- Skip login attempts if login failed to get a response.
- Skip requests when a certain error condition has been met.

```yaml
skipIf: ${LoginResponse.StatusCode} = 401
skipIf: ${LoginResponse.Body.token} = ""
skipIf: ${Metrics.Load.Heavy.Duration.P90ResponseTime} > 250
```

### Failure Criteria
The `failureCriteria` property defines rules that are applied **after the iteration finishes**. These rules classify the outcome of the iteration as either **Failed** or **Success**.  
This is useful for reporting and post-run analysis.

Supported rules include:
- **maxErrorRate**: Maximum allowed error rate.
- **errorStatusCodes**: Specific status codes to count as errors.
- **maxP90, maxP50, maxP10, maxAvg**: Response time thresholds.

```yaml
failureCriteria:
  maxErrorRate: 0.10
  errorStatusCodes: "404,403,500"
  maxP90: 250
  maxP50: 200
  maxP10: 150
  maxAvg: 180
```

### Termination Rules

The `terminationRules` property lets customers define real-time termination conditions for an iteration. These rules are evaluated continuously by the Master node (aggregating all workers).
An iteration will be terminated only if a rule is continuously violated for the entire grace period.
For example, with a grace period of 10 seconds, if the violation clears before the 10th second, the test continues without termination.

Supported rules include:
- **maxErrorRate**: Maximum allowed error rate in real-time.
- **errorStatusCodes**: Error codes that trigger termination.
- **maxP90**: Latency thresholds that must not be exceeded.
- **gracePeriod**: Time to tolerate violations before termination.

```yaml
terminationRules:
  - maxErrorRate: 0.2
    errorStatusCodes: "404,403,500"
    maxP90: 200
    gracePeriod: 10s
  - maxP50: 400
    gracePeriod: 15s
```

## Complete Iteration Example

```yaml
name: IterationFeaturesPlan # Represents the plan name
rounds:
  - name: FeatureRound
    numberOfClients: 50
    arrivalDelay: 100
    runInParallel: false
    iterations:
      - name: LoginIteration
        httpRequest:
          url: https://httpbin.org/post
          method: POST
          headers:
            Content-Type: application/json
          payload:             
            raw: |
                { "username": "user", "password": "pass" }
      - name: Home
        httpRequest:
          url: https://httpbin.org/
          httpMethod: Get

        # SkipIf (iteration)
        skipIf: ${LoginResponse.StatusCode} = 401

        # Failure Criteria (executed once the iteration execution is completed)
        failureCriteria:
          maxErrorRate: 0.10
          errorStatusCodes: "404,403,500"
          maxP90: 250
          maxP50: 200
          maxP10: 150
          maxAvg: 180

        # Termination Rules
        terminationRules:
          - maxErrorRate: 0.2
            errorStatusCodes: "404,403,500"
            gracePeriod: "00:00:03"
          - maxP90: 2000
            gracePeriod: "00:00:05"
```

## Global Iterations and References
Iterations can also be defined as **global iterations** and referenced later within rounds using the `reference` property. This allows for reusable iteration configurations across multiple rounds, reducing redundancy and improving maintainability.

### Example
```yaml
name: GlobalIterationPlan
iterations:
- name: GlobalIteration
  mode: DCB
  duration: 300
  batchSize: 100
  coolDownTime: 1000
  httpRequest:
    url: https://httpbin.org/headers
    httpMethod: GET
    httpVersion: 2.0
rounds:
- name: TestRound
  numberOfClients: 1
  reference: ["GlobalIteration"]
```
