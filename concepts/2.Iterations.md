# Understanding Iterations

An **Iteration** defines the individual scenario performed during a round. The iteration mode controls how the iteration operates.

## Key Attributes of an Iteration
- **Name**: Identifier for the iteration.
- **HTTP Request**: Configuration for the request, including the method, URL, headers, and payload.
- **Mode**: Defines how the iteration operates (see **[Iteration Modes](https://github.com/mohaidr/lps-docs/blob/main/concepts/3.Iteration_Modes.md)**).
- **Startup Delay**: Optional delay before starting the iteration.
- **MaximizeThroughput (iteration)**  `maximizeThroughput: true` to push send-rate as fast as other constraints allow. <mark>Maximizing the throughput will result in higher CPU and Memory usage</mark>

**Structure**  
- The plan is at the **document root** (no `plan:` key).
- **Rounds** are required; each round contains one or more **iterations**.
- Each iteration typically contains an **httpRequest**.

## Iteration Features

### Itration Modes

- Iteration Modes control the pattern and timing of HTTP requests, offering flexibility to simulate various user behaviors and system loads. (see **[Iteration Modes](https://github.com/mohaidr/lps-docs/blob/main/concepts/3.Iteration_Modes.md)**).

### SkipIf
The `skipIf` property allows conditional execution of an iteration. If the condition evaluates to **true**, the iteration will be skipped.  
Conditions can use [Flee expressions](https://github.com/mparlak/Flee) and may reference session/global variables, placeholders, and metrics.

Example use cases:
- Skip login attempts if login failed to get a response.
- Skip requests when a certain error condition has been met.

```yaml
skipIf: ${LoginResponse.StatusCode} = 401
skipIf: ${LoginResponse.Body.token} = ""
skipIf: ${Metrics.Load.Heavy.Duration.P90ResponseTime} > 250
```

### Failure Rules

> **⚠️ Breaking Change:** The old `failureCriteria` property with individual threshold fields (`maxErrorRate`, `maxP90`, `maxP50`, `maxP10`, `maxAvg`, `errorStatusCodes`) has been **permanently removed** as of version **3.0.2.6**. The last version supporting the old format was **3.0.2.5**. Please migrate to the new `failureRules` format described below.

The `failureRules` property defines rules that are applied **after the iteration finishes**. These rules classify the outcome of the iteration as either **Failed** or **Success**.  
This is useful for reporting and post-run analysis.

Each rule uses the **inline metric expression** format (see [Metric Expression Reference](#metric-expression-reference) below).

```yaml
failureRules:
  - metric: "ErrorRate > 0.10"
    errorStatusCodes: ">= 500"
  - metric: "TotalTime.P90 > 250"
  - metric: "TotalTime.P50 > 200"
  - metric: "TotalTime.Avg > 180"
```

#### CLI Usage
You can also specify failure rules via command line:
```bash
lps --url https://example.com -rc 1000 --failurerule "ErrorRate > 0.05;>= 500" --failurerule "TotalTime.P90 > 250"
```

Format: `"metric[;errorStatusCodes]"`

### Termination Rules

> **⚠️ Breaking Change:** The old `terminationRules` format with individual threshold fields (`maxErrorRate`, `maxP90`, `maxP50`, `errorStatusCodes`) has been **permanently removed** as of version **3.0.2.6**. The last version supporting the old format was **3.0.2.5**. Please migrate to the new format described below.

The `terminationRules` property lets you define real-time termination conditions for an iteration. These rules are evaluated continuously by the Master node (aggregating all workers).
An iteration will be terminated only if a rule is continuously violated for the entire grace period.
For example, with a grace period of 10 seconds, if the violation clears before the 10th second, the test continues without termination.

Each rule uses the **inline metric expression** format (see [Metric Expression Reference](#metric-expression-reference) below), plus a required `gracePeriod`.

```yaml
terminationRules:
  - metric: "ErrorRate > 0.2"
    errorStatusCodes: ">= 500"
    gracePeriod: "00:00:10"
  - metric: "TotalTime.P90 > 200"
    gracePeriod: "00:00:05"
  - metric: "TotalTime.P50 > 400"
    gracePeriod: "00:00:15"
```

#### CLI Usage
You can also specify termination rules via command line:
```bash
lps --url https://example.com -rc 1000 --terminationrule "ErrorRate > 0.10;00:05:00;>= 500" --terminationrule "TotalTime.P90 > 500;00:00:30"
```

Format: `"metric;gracePeriod[;errorStatusCodes]"`

---

### Metric Expression Reference

Both `failureRules` and `terminationRules` use the same inline metric expression format.

#### Expression Format
```
MetricName[.Statistic] Operator Threshold
```

#### Supported Metrics

| Metric | Aliases | Statistics | Description | Example |
|--------|---------|------------|-------------|---------|
| `ErrorRate` | - | (none) | Percentage of failed requests | `"ErrorRate > 0.05"` |
| `Throughput` | `RPS`, `RequestsPerSecond` | (none) | Requests per second | `"Throughput < 100"` |
| `TotalTime` | - | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Total request duration | `"TotalTime.P90 > 250"` |
| `TTFB` | `TimeToFirstByte` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Time to first byte received | `"TTFB.P90 > 100"` |
| `WaitingTime` | `Waiting` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Server processing time (TTFB - TCP - TLS) | `"WaitingTime.P90 > 80"` |
| `TCPHandshake` | `TCP` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | TCP connection handshake time | `"TCPHandshake.Avg > 50"` |
| `TLSHandshake` | `TLS`, `SSL`, `SSLHandshake` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | TLS/SSL handshake time | `"TLSHandshake.P90 > 100"` |
| `SendingTime` | `Sending`, `Upload`, `Upstream` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Request upload time | `"SendingTime.P90 > 20"` |
| `ReceivingTime` | `Receiving`, `Download`, `Downstream` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Response download time | `"ReceivingTime.P90 > 50"` |
| `ServerTime` | `Server` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Total server time from `Server-Timing` header | `"ServerTime.P90 > 100"` |
| `ServerTimeDB` | `DB`, `Database` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Database time from `Server-Timing` header | `"ServerTimeDB.P90 > 50"` |
| `ServerTimeCache` | `Cache` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Cache time from `Server-Timing` header | `"ServerTimeCache.Avg > 10"` |
| `ServerTimeApp` | `App`, `Application` | `.P50`, `.P90`, `.P95`, `.P99`, `.Avg`, `.Min`, `.Max` | Application time from `Server-Timing` header | `"ServerTimeApp.P90 > 80"` |

> **Note:** The `ServerTime*` metrics require the server to include a [`Server-Timing`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Server-Timing) HTTP response header with the relevant timing information.

#### Supported Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `>` | Greater than | `"ErrorRate > 0.05"` |
| `>=` | Greater than or equal | `"TotalTime.P90 >= 500"` |
| `<` | Less than | `"Throughput < 100"` |
| `<=` | Less than or equal | `"TotalTime.Avg <= 200"` |
| `=` | Equal | `"ErrorRate = 0"` |
| `!=` | Not equal | `"ErrorRate != 0"` |
| `between X and Y` | Range (inclusive) | `"TotalTime.P90 between 100 and 500"` |

#### Error Status Code Filtering

The optional `errorStatusCodes` property filters which HTTP status codes count as errors when calculating `ErrorRate`.

| Expression | Description |
|------------|-------------|
| `">= 500"` | All 5xx server errors |
| `">= 400"` | All 4xx and 5xx errors |
| `"< 500"` | All non-5xx errors (including 4xx) |
| `"between 400 and 499"` | Only 4xx client errors |
| `"= 429"` | Only rate limiting errors |
| `"= 0"` | Connectivity failures only |
| `">= 0"` | All errors including connectivity failures |

> **Note:** Status code `0` represents **connectivity failures** including DNS resolution failures, connection refused, connection timeout, SSL/TLS handshake failures, and network unreachable errors.

---

## Complete Iteration Example

```yaml
name: IterationFeaturesPlan # Represents the plan name
rounds:
  - name: FeatureRound
    numberOfClients: 50
    arrivalDelay: 100
    runInParallel: false
    iterations:
      - name: LoginIteration
        httpRequest:
          url: https://httpbin.org/post
          method: POST
          headers:
            Content-Type: application/json
          payload:             
            raw: |
                { "username": "user", "password": "pass" }
      - name: Home
        httpRequest:
          url: https://httpbin.org/
          httpMethod: Get

        # SkipIf (iteration)
        skipIf: ${LoginResponse.StatusCode} = 401

        # Failure Rules (evaluated once the iteration execution is completed)
        failureRules:
          - metric: "ErrorRate > 0.10"
            errorStatusCodes: ">= 400"
          - metric: "TotalTime.P90 > 250"
          - metric: "TotalTime.P50 > 200"
          - metric: "TotalTime.Avg > 180"

        # Termination Rules (evaluated in real-time during execution)
        terminationRules:
          - metric: "ErrorRate > 0.2"
            errorStatusCodes: ">= 400"
            gracePeriod: "00:00:03"
          - metric: "TotalTime.P90 > 2000"
            gracePeriod: "00:00:05"
```

## Global Iterations and References
Iterations can also be defined as **global iterations** and referenced later within rounds using the `reference` property. This allows for reusable iteration configurations across multiple rounds, reducing redundancy and improving maintainability.

### Example
```yaml
name: GlobalIterationPlan
iterations:
- name: GlobalIteration
  mode: DCB
  duration: 300
  batchSize: 100
  coolDownTime: 1000
  httpRequest:
    url: https://httpbin.org/headers
    httpMethod: GET
    httpVersion: 2.0
rounds:
- name: TestRound
  numberOfClients: 1
  reference: ["GlobalIteration"]
```
