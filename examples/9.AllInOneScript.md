
# Complex Example: Demonstrating Multiple Capabilities of the LPS Tool

```yaml
name: SecureDataExample
variables:
- name: baseUrl
  value: https://example.com
- name: tokenEndpoint
  value: ${baseUrl}/auth/token
- name: dataEndpoint
  value: ${baseUrl}/data
- name: csvData
  value: $read(path=data/users.csv)
  as: csv
- name: number
  value: 10
  as: int
rounds:
- name: SecureDataRound
  numberOfClients: 100
  arrivalDelay: 100
  runInParallel: false
  iterations:
  - name: FetchToken
    httpRequest:
      url: $tokenEndpoint
      httpMethod: POST
      payload:
        raw: '{"client_id": "$users[$counter(counter=namesCounter, start=0, reset=5),1]", "client_secret": "$users[$counter(counter=passwordsCounter, start=0, reset=5),2]"}'
      capture:
        to: authResponse
        as: qjson
      httpHeaders:
        Content-Type: application/json
  - name: GetData
    skipIf: '${authResponse.Body.access_token} = "" or $authResponse.StatusCode <>200' ## Placeholders which contains stoppers like the underscore (_) bereaks the place holder resolutions if the placeholder is not wrapped by {}
    httpRequest:
      url: $dataEndpoint
      httpMethod: Get
  - name: GetPaginatedData
    mode: R
    requestCount: 10
    skipIf: '${authResponse.Body.access_token} = "" or $authResponse.StatusCode <>200' ## Placeholders which contains stoppers like the underscore (_) bereaks the place holder resolutions if the placeholder is not wrapped by {}
    httpRequest:
      url: $dataEndpoint/?page=$counter(counter=pageCounter, start=0, reset=200, step=20)
      httpMethod: Get
    failureRules:
      - metric: "ErrorRate > 0.3"
        errorStatusCodes: ">= 400"
    terminationRules:
      - metric: "ErrorRate > 0.3"
        errorStatusCodes: ">= 400"
        gracePeriod: "00:00:03"
      - metric: "TotalTime.P90 > 400"
        gracePeriod: "00:00:10"
environments:
- name: production
  variables:
  - name: environment
    value: production
    as: qstring
  - name: baseUrl
    value: https://example.com
```

## üß© Overview
The **`SecureDataExample`** plan demonstrates many of the advanced capabilities of the **LPS tool** in one scenario.  

It simulates a **secure data-fetching workflow** where:
1. Tokens are fetched from an authentication endpoint.  
2. Those tokens are used to retrieve paginated data from a protected API.  
3. The test runs under specific conditions, with failure rules and termination rules.

---

## üîß Variables Section

### Defined Variables

| Variable | Description |
|-----------|--------------|
| **`baseUrl`** | Base URL for the API requests (e.g., `https://example.com`). |
| **`tokenEndpoint`** | Built dynamically using `${baseUrl}` ‚Üí `https://example.com/auth/token`. |
| **`dataEndpoint`** | Built dynamically as `${baseUrl}/data`. |
| **`csvData`** | Reads data from a CSV file located at `data/users.csv`. The `as: csv` means it will be parsed into rows and columns. |
| **`number`** | A numeric variable with value `10`, explicitly typed as integer. |

üß† The `$read()` function demonstrates how LPS can pull external data into tests.

---

## üîÅ Rounds Section

### **Round Name:** `SecureDataRound`

This round represents a complete test phase.

| Property | Description |
|-----------|-------------|
| **`numberOfClients`** | 100 virtual users simulate concurrent clients. |
| **`arrivalDelay`** | Each client starts after a 100 ms delay to avoid simultaneous starts. |
| **`runInParallel`** | `false` means that the iterations will run sequentially. |

---

### **Iteration 1: `FetchToken`**

Simulates a login or token retrieval request.

**Details:**
- Sends a **POST** request to `$tokenEndpoint`.
- Uses dynamic credentials pulled from the CSV file:
  ```yaml
  "client_id": "$users[$counter(counter=namesCounter, start=0, reset=5),1]",
  "client_secret": "$users[$counter(counter=passwordsCounter, start=0, reset=5),2]"
  ```
  - `$counter` cycles through CSV rows.
  - `start=0` ‚Üí starts from row 0.
  - `reset=5` ‚Üí after 5 cycles, it resets.
  - `[ ,1]` ‚Üí refers to column index 1.

- The request body is JSON with `Content-Type: application/json`.
- The response is captured into a variable called `authResponse` as `qjson` (quoted JSON).

---

### **Iteration 2: `GetData`**

Fetches protected data **only if the token is valid**.

**Key condition:**
```yaml
skipIf: '${authResponse.Body.access_token} = "" or $authResponse.StatusCode <>200'
```

- Prevents running this iteration if:
  - The token (`access_token`) is empty, or  
  - The request failed (`StatusCode` not equal to 200).  

üí° Note: Placeholders containing underscores or any special character like (`_`) must be wrapped with `${}`.

---

### **Iteration 3: `GetPaginatedData`**

Tests repeated (looped) requests under certain conditions.

| Property | Description |
|-----------|-------------|
| **`mode: R`** | ‚ÄúRepeat‚Äù mode ‚Äî repeats requests multiple times. |
| **`requestCount: 10`** | Each client sends 10 repeated requests. |
| **`skipIf`** | Same condition as before (skip if token invalid). |
| **`httpRequest.url`** | Adds a page number using `$counter` with step increments of 20. |
| **`failureRules`** | Defines when the iteration is marked as failed after completion. Uses inline metric expressions. |
| **`terminationRules`** | Defines **live stop conditions** during execution. Uses inline metric expressions. |

> **‚ö†Ô∏è Note:** The old `failureCriteria` format (with `maxErrorRate`, `maxP90`, etc.) and old `terminationRules` format have been **permanently removed** as of version **3.0.2.6**. The last version supporting the old format was **3.0.2.5**.

#### Failure Rules

The `failureRules` use an inline metric expression format:
```yaml
failureRules:
  - metric: "ErrorRate > 0.3"
    errorStatusCodes: ">= 400"
```
- If the error rate exceeds **30%** (counting 4xx and 5xx errors), the iteration is marked as **Failed**.

#### Termination Rules

1. **Error-based rule**
   ```yaml
   - metric: "ErrorRate > 0.3"
     errorStatusCodes: ">= 400"
     gracePeriod: "00:00:03"
   ```
   - If errors exceed **30%** for **3 continuous seconds**, the iteration stops.

2. **Latency-based rule**
   ```yaml
   - metric: "TotalTime.P90 > 400"
     gracePeriod: "00:00:10"
   ```
   - If **P90 latency** exceeds **400 ms** for **10 continuous seconds**, the iteration stops.

These rules are continuously monitored by the **master node**.

---

## üåê Environments Section

Defines environment-specific overrides.

| Variable | Description |
|-----------|-------------|
| **`environment`** | Marks this environment as `"production"`. |
| **`baseUrl`** | Overrides the base URL to `https://example.com`. |

‚úÖ This allows running the same plan across environments (staging, production, etc.) just by switching the flag.

---

## üöÄ Run Command
```bash
lps run SecureDataExample.yaml --environment production
```
Executes the test plan using the **production** environment variables.

---

## üß† Summary

| Concept | Demonstrated Feature |
|----------|----------------------|
| Variables | Basic, dynamic, environment-specific, and from CSV. |
| Loops | `$counter()` for cycling through CSV rows or paginated requests. |
| Capture | Store response data into variables for later use. |
| Conditional Execution | `skipIf` to skip iterations based on runtime logic. |
| Metrics & Termination | Failure rules and real-time termination rules using inline metric expressions. |
| Environments | Override variables cleanly per environment. |

---

### üèÅ In Short
This example simulates **logging in with multiple user credentials**, **fetching secure data**, and **paging through results** ‚Äî all while automatically stopping when error or performance thresholds are breached.  

It demonstrates how **LPS dynamically controls test behavior** using variables, metrics, and intelligent execution rules.
